{% extends "deliverer/base_livreur.html" %}

{% block title %}Profil Livreur{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white rounded-lg shadow p-4 border border-emerald-100">
            <p class="text-sm text-gray-500">Commission due</p>
            <p class="text-2xl font-bold text-emerald-700">{{ convert_price(current_user.commission_due or 0, from_currency=base_currency) }}</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 border border-emerald-100">
            <p class="text-sm text-gray-500">Livraisons ce mois</p>
            <p class="text-2xl font-bold text-emerald-700">{{ monthly_stats.deliveries_this_month }}</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 border border-emerald-100">
            <p class="text-sm text-gray-500">Commission ce mois</p>
            <p class="text-2xl font-bold text-emerald-700">{{ convert_price(monthly_stats.commission_this_month, from_currency=base_currency) }}</p>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Mettre à jour le profil</h3>
        <form action="{{ url_for('deliverer_profile') }}" method="POST" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div>
                <label class="block text-sm text-gray-700 mb-1">Prénom</label>
                <input type="text" name="first_name" value="{{ current_user.first_name }}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500">
            </div>
            <div>
                <label class="block text-sm text-gray-700 mb-1">Nom</label>
                <input type="text" name="last_name" value="{{ current_user.last_name }}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500">
            </div>
            <div>
                <label class="block text-sm text-gray-700 mb-1">Téléphone</label>
                <input type="text" name="phone" value="{{ current_user.phone }}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500">
            </div>
            <div>
                <label class="block text-sm text-gray-700 mb-1">Adresse</label>
                <input type="text" name="address" value="{{ current_user.address }}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" id="deliverer_address_field">
                <input type="hidden" id="deliverer_address_lat">
                <input type="hidden" id="deliverer_address_lon">
                <input type="hidden" id="deliverer_address_label">
                <div class="mt-2 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                    <button type="button"
                            class="px-3 py-2 bg-emerald-100 text-emerald-700 rounded-lg border border-emerald-200 hover:bg-emerald-50 flex items-center gap-2 w-full sm:w-auto justify-center"
                            data-geo-btn
                            data-geo-target="deliverer_address_field"
                            data-geo-lat="deliverer_address_lat"
                            data-geo-lon="deliverer_address_lon"
                            data-geo-label="deliverer_address_label"
                            data-geo-map="deliverer_address_map"
                            data-geo-status="deliverer_address_status">
                        <i class="fas fa-location-crosshairs"></i>
                        <span>Me géolocaliser</span>
                    </button>
                    <p id="deliverer_address_status" class="text-xs text-gray-500">Utilisez votre position actuelle pour remplir l'adresse.</p>
                </div>
                <div class="mt-2 hidden" id="deliverer_address_map_wrapper">
                    <iframe id="deliverer_address_map" class="w-full h-40 rounded-lg border" loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade"></iframe>
                </div>
            </div>
            <div>
                <label class="block text-sm text-gray-700 mb-1">Photo de profil</label>
                <input type="file" name="profile_picture" accept="image/*" class="w-full">
            </div>
            <div>
                <label class="block text-sm text-gray-700 mb-1">Nouveau mot de passe</label>
                <input type="password" name="password" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500" placeholder="Laisser vide si inchangé">
            </div>
            <div class="md:col-span-2 text-right">
                <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Enregistrer</button>
            </div>
        </form>
    </div>

    <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Historique des commissions payées</h3>
        {% if commission_history %}
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            {% for item in commission_history %}
            <div class="border rounded-lg p-3 bg-gray-50">
                <p class="text-sm text-gray-500">Mois</p>
                <p class="font-semibold text-gray-800">{{ item.month }}</p>
                <p class="text-sm text-gray-500 mt-1">Livraisons payées</p>
                <p class="font-semibold text-gray-800">{{ item.count }}</p>
                <p class="text-sm text-gray-500 mt-1">Montant</p>
                <p class="font-semibold text-emerald-700">{{ convert_price(item.amount, from_currency=base_currency) }}</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-sm text-gray-500">Aucune commission payée pour le moment.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
