{% extends "basee.html" %}

{% block title %}Produits - Admin{% endblock %}
{% block header_title %}Catalogue produits{% endblock %}
{% set can_manage_products = current_user.has_permission('manage_products') or current_user.is_super_admin %}

{% block content %}
<div class="space-y-6">
    <!-- Actions -->
    <div class="bg-white rounded-lg shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h2 class="text-xl font-semibold text-gray-800">Produits</h2>
            <p class="text-gray-500">Recherche, ajout et export du catalogue.</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <form method="GET" action="{{ url_for('admin_products') }}" class="flex items-center gap-2">
                <input type="text" name="q" value="{{ search_term }}" placeholder="Rechercher un produit..."
                       class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button type="submit" class="px-3 py-2 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200">
                    <i class="fas fa-search"></i>
                </button>
            </form>
            {% if can_manage_products %}
            <a href="{{ url_for('admin_export_products_pdf') }}" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2 currency-prompt-download">
                <i class="fas fa-file-pdf"></i><span>Exporter PDF</span>
            </a>
            <button type="submit" form="bulkDeleteProductsForm" class="px-4 py-2 bg-red-700 text-white rounded-lg hover:bg-red-800 flex items-center gap-2">
                <i class="fas fa-trash"></i><span>Supprimer sélection</span>
            </button>
            <button onclick="toggleProductForm()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
                <i class="fas fa-plus"></i><span>Ajouter</span>
            </button>
            {% else %}
            <span data-feature="Exporter PDF" class="inactive-feature px-4 py-2 bg-red-600 text-white rounded-lg opacity-70 cursor-not-allowed">Exporter PDF</span>
            <span data-feature="Suppression groupée" class="inactive-feature px-4 py-2 bg-red-100 text-red-500 rounded-lg opacity-70 cursor-not-allowed">Supprimer sélection</span>
            <span data-feature="Nouveau Produit" class="inactive-feature px-4 py-2 bg-gray-200 text-gray-600 rounded-lg opacity-70 cursor-not-allowed">Ajouter</span>
            {% endif %}
        </div>
    </div>

    {% if can_manage_products %}
    <form id="bulkDeleteProductsForm" action="{{ url_for('admin_bulk_delete_products') }}" method="POST" class="hidden">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    </form>
    {% endif %}

    <!-- Formulaire -->
    <div id="productForm" class="bg-white rounded-lg shadow p-6 hidden">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Ajouter un produit</h3>
            <button onclick="toggleProductForm()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
        </div>
        <form action="{{ url_for('admin_add_product') }}" method="POST" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                <input type="text" name="name" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Catégorie</label>
                <select name="category_id" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                    <option value="">Choisir...</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Prix ({{ current_currency or base_currency }})</label>
                <input type="number" name="price" step="0.01" min="0" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="{{ current_currency or base_currency }}">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Quantité</label>
                <input type="number" name="quantity" min="0" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Statut</label>
                <select name="is_active" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                    <option value="true" selected>Actif</option>
                    <option value="false">Inactif</option>
                </select>
            </div>
            <div>
                <span class="block text-sm font-medium text-gray-700 mb-1">Produit phare</span>
                <label class="inline-flex items-center space-x-2 text-sm text-gray-600">
                    <input type="checkbox" name="is_featured" class="text-purple-600 rounded">
                    <span>Afficher dans "Produits phares"</span>
                </label>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea name="description" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Images (upload)</label>
                <input type="file" name="images" accept="image/*" multiple class="w-full">
                <p class="text-xs text-gray-500 mt-1">Formats acceptés: png, jpg, jpeg, gif, webp.</p>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">URLs d'images (une par ligne)</label>
                <textarea name="image_urls" rows="3" placeholder="https://example.com/image.jpg" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Vidéos (max 3)</label>
                <input type="file" name="videos" accept="video/mp4,video/webm,video/quicktime,video/x-m4v" multiple class="w-full">
                <p class="text-xs text-gray-500 mt-1">Formats acceptés: mp4, webm, mov, m4v.</p>
            </div>
            <div class="md:col-span-2 flex justify-end gap-3">
                <button type="button" onclick="toggleProductForm()" class="px-4 py-2 border rounded-lg">Annuler</button>
                <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
            </div>
        </form>
    </div>
    <!-- Liste -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                            {% if can_manage_products %}
                            <input type="checkbox" id="selectAllProducts" class="h-4 w-4 text-purple-600 border-gray-300 rounded">
                            {% endif %}
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produit</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Catégorie</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prix</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stock</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phare</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for product in products %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4">
                            {% if can_manage_products %}
                            <input type="checkbox" name="product_ids" value="{{ product.id }}" form="bulkDeleteProductsForm" class="h-4 w-4 text-purple-600 border-gray-300 rounded">
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                {% set img = get_first_image_url(product) %}
                                {% if img %}
                                <img src="{{ img }}" alt="{{ product.name }}" class="h-12 w-12 rounded-lg object-cover border">
                                {% else %}
                                <div class="h-12 w-12 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                                    <i class="fas fa-book"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <div class="text-sm font-semibold text-gray-900">{{ product.name }}</div>
                                    <div class="text-xs text-gray-500 line-clamp-2">{{ product.description or '—' }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-800">{{ product.category.name if product.category else 'N/C' }}</td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ convert_price(product.price, from_currency=base_currency) }}</td>
                        <td class="px-6 py-4 text-sm text-gray-800">{{ product.quantity }}</td>
                        <td class="px-6 py-4">
                            {% if product.is_featured %}
                            <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">Oui</span>
                            {% else %}
                            <span class="text-xs text-gray-400">—</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            {% if product.is_active %}
                            <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">Actif</span>
                            {% else %}
                            <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700">Inactif</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="flex items-center gap-2">
                                {% if can_manage_products %}
                                <button type="button" class="text-blue-600 hover:text-blue-800" title="Modifier" data-edit-toggle="edit-{{ product.id }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form action="{{ url_for('admin_delete_product', product_id=product.id) }}" method="GET" onsubmit="return confirm('Supprimer ce produit ?')" title="Supprimer">
                                    <button type="submit" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                                </form>
                                {% else %}
                                <span data-feature="Gestion produit" class="inactive-feature text-gray-400 cursor-not-allowed"><i class="fas fa-ban"></i></span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% if can_manage_products %}
                    <tr id="edit-{{ product.id }}" class="hidden bg-gray-50">
                        <td colspan="8" class="px-6 py-4">
                            <form action="{{ url_for('admin_edit_product', product_id=product.id) }}" method="POST" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Nom</label>
                                    <input type="text" name="name" value="{{ product.name }}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Prix ({{ current_currency or base_currency }})</label>
                                    <input type="number" step="0.01" name="price" value="{{ product.price }}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Quantité</label>
                                    <input type="number" name="quantity" value="{{ product.quantity }}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Catégorie</label>
                                    <select name="category_id" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                        {% for category in categories %}
                                        <option value="{{ category.id }}" {% if product.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Statut</label>
                                    <select name="is_active" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="true" {% if product.is_active %}selected{% endif %}>Actif</option>
                                        <option value="false" {% if not product.is_active %}selected{% endif %}>Inactif</option>
                                    </select>
                                </div>
                                <div>
                                    <span class="block text-xs font-semibold text-gray-600 mb-1">Produit phare</span>
                                    <label class="inline-flex items-center space-x-2 text-xs text-gray-600">
                                        <input type="checkbox" name="is_featured" class="text-purple-600 rounded" {% if product.is_featured %}checked{% endif %}>
                                        <span>Afficher dans "Produits phares"</span>
                                    </label>
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Description</label>
                                    <textarea name="description" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">{{ product.description }}</textarea>
                                </div>
                                <div>
                                    <label class="inline-flex items-center space-x-2 text-xs font-semibold text-gray-600 mb-1">
                                        <input type="checkbox" name="replace_images" class="text-purple-600 rounded">
                                        <span>Remplacer les images existantes</span>
                                    </label>
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Images (upload)</label>
                                    <input type="file" name="images" accept="image/*" multiple class="w-full text-xs">
                                    <p class="text-[11px] text-gray-500 mt-1">Formats acceptés: png, jpg, jpeg, gif, webp.</p>
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">URLs d'images (une par ligne)</label>
                                    <textarea name="image_urls" rows="2" placeholder="https://example.com/image.jpg" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                                </div>
                                <div>
                                    <label class="inline-flex items-center space-x-2 text-xs font-semibold text-gray-600 mb-1">
                                        <input type="checkbox" name="replace_videos" class="text-purple-600 rounded">
                                        <span>Remplacer les vidéos existantes</span>
                                    </label>
                                    {% set video_count = product.videos.split('|')|length if product.videos else 0 %}
                                    <p class="text-[11px] text-gray-500">Vidéos actuelles: {{ video_count }}</p>
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-semibold text-gray-600 mb-1">Vidéos (max 3)</label>
                                    <input type="file" name="videos" accept="video/mp4,video/webm,video/quicktime,video/x-m4v" multiple class="w-full text-xs">
                                    <p class="text-[11px] text-gray-500 mt-1">Formats acceptés: mp4, webm, mov, m4v.</p>
                                </div>
                                <div class="md:col-span-3 flex justify-end gap-2">
                                    <button type="button" class="px-3 py-2 border rounded-lg text-gray-700" data-edit-toggle="edit-{{ product.id }}">Annuler</button>
                                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
                                </div>
                            </form>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if products|length == 0 %}
        <div class="text-center py-12 text-gray-500">Aucun produit trouvé.</div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleProductForm(){
    document.getElementById('productForm').classList.toggle('hidden');
}

document.addEventListener('DOMContentLoaded', () => {
    const bulkForm = document.getElementById('bulkDeleteProductsForm');
    const selectAll = document.getElementById('selectAllProducts');
    const checkboxes = Array.from(document.querySelectorAll('input[name="product_ids"]'));

    const updateSelectAll = () => {
        if (!selectAll) return;
        if (!checkboxes.length) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
            return;
        }
        const checkedCount = checkboxes.filter(cb => cb.checked).length;
        selectAll.checked = checkedCount === checkboxes.length;
        selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
    };

    if (selectAll) {
        selectAll.addEventListener('change', () => {
            checkboxes.forEach(cb => { cb.checked = selectAll.checked; });
            updateSelectAll();
        });
    }
    checkboxes.forEach(cb => cb.addEventListener('change', updateSelectAll));
    updateSelectAll();

    if (bulkForm) {
        bulkForm.addEventListener('submit', (e) => {
            const selected = checkboxes.filter(cb => cb.checked);
            if (!selected.length) {
                e.preventDefault();
                alert('Aucun produit sélectionné.');
                return;
            }
            if (!confirm(`Supprimer ${selected.length} produit(s) sélectionné(s) ?`)) {
                e.preventDefault();
            }
        });
    }

    const currencies = {{ available_currencies|tojson|safe }};
    const defaultCurrency = "{{ (current_currency or base_currency)|upper }}";
    const normalize = (val) => (val || '').trim().toUpperCase();
    document.querySelectorAll('.currency-prompt-download').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const href = link.getAttribute('href');
            if (!href) return;
            const choice = prompt(`Choisissez la devise pour l'export (${currencies.join(', ')})`, defaultCurrency);
            if (!choice) return;
            const code = normalize(choice);
            if (!currencies.map(normalize).includes(code)) {
                alert('Devise non supportée.');
                return;
            }
            const separator = href.includes('?') ? '&' : '?';
            window.location.href = `${href}${separator}currency=${encodeURIComponent(code)}`;
        });
    });

    // Toggle edit rows
    document.querySelectorAll('[data-edit-toggle]').forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-edit-toggle');
            const row = document.getElementById(targetId);
            if (row) {
                row.classList.toggle('hidden');
            }
        });
    });
});
</script>
{% endblock %}
