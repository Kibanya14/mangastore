<style>
    .wa-shell {
        background: #f0f2f5;
        border-radius: 28px;
        border: 1px solid #d9e0e4;
        box-shadow: 0 28px 70px rgba(15, 23, 42, 0.12);
        overflow: hidden;
    }
    .wa-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 320px;
        min-height: 70vh;
    }
    .wa-chat {
        display: flex;
        flex-direction: column;
        background: #efeae2;
        min-height: 70vh;
    }
    .wa-chat-header {
        background: #075e54;
        color: #fff;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .wa-chat-title {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .wa-chat-title-icon {
        height: 38px;
        width: 38px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.18);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }
    .wa-chat-sub {
        font-size: 12px;
        opacity: 0.8;
    }
    .wa-chat-window {
        flex: 1;
        overflow-y: auto;
        padding: 18px;
        background: #efeae2;
        background-image: radial-gradient(rgba(255, 255, 255, 0.22) 1px, transparent 1px);
        background-size: 18px 18px;
    }
    .wa-message-row {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
        align-items: flex-end;
    }
    .wa-message-row.is-me {
        justify-content: flex-end;
        flex-direction: row-reverse;
    }
    .wa-avatar {
        height: 36px;
        width: 36px;
        border-radius: 999px;
        overflow: hidden;
        background: #d1d5db;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        color: #475569;
    }
    .wa-message {
        max-width: 560px;
        width: 100%;
    }
    .wa-message-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: #52636b;
        margin-bottom: 4px;
    }
    .wa-role {
        background: rgba(0, 0, 0, 0.07);
        color: #334155;
        padding: 2px 8px;
        border-radius: 999px;
        text-transform: capitalize;
        font-size: 10px;
        font-weight: 600;
    }
    .wa-bubble {
        background: #fff;
        border-radius: 12px;
        padding: 10px 12px;
        position: relative;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
    }
    .wa-bubble.me { background: #d9fdd3; }
    .wa-bubble::after {
        content: "";
        position: absolute;
        top: 10px;
        left: -6px;
        width: 12px;
        height: 12px;
        background: inherit;
        transform: rotate(45deg);
        border-radius: 2px;
    }
    .wa-message-row.is-me .wa-bubble::after {
        left: auto;
        right: -6px;
    }
    .wa-text {
        white-space: pre-line;
        font-size: 14px;
        color: #1f2937;
    }
    .wa-attachment { margin-top: 8px; }
    .wa-attachment img,
    .wa-attachment video {
        border-radius: 12px;
        max-height: 240px;
        width: 100%;
        object-fit: contain;
    }
    .wa-time {
        display: block;
        text-align: right;
        margin-top: 6px;
        font-size: 10px;
        color: #64748b;
    }
    .wa-actions {
        margin-top: 4px;
        display: flex;
        gap: 12px;
        font-size: 11px;
        color: #64748b;
    }
    .wa-actions button { display: flex; align-items: center; gap: 4px; }
    .wa-edit { margin-top: 6px; }
    .wa-edit textarea {
        width: 100%;
        border-radius: 14px;
        border: 1px solid #d1d5db;
        padding: 8px 10px;
    }
    .wa-edit .wa-edit-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 6px;
    }
    .wa-composer {
        background: #f0f2f5;
        padding: 12px 14px;
        border-top: 1px solid #d9e0e4;
    }
    .wa-input-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    .wa-icon-btn {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        background: #fff;
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #475569;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .wa-icon-btn:hover { background: #f8fafc; color: #0f766e; }
    .wa-icon-btn.is-recording {
        background: #dcfce7;
        border-color: #86efac;
        color: #16a34a;
    }
    .wa-textarea {
        flex: 1;
        min-width: 200px;
        border-radius: 999px;
        border: 1px solid #e2e8f0;
        padding: 10px 14px;
        background: #fff;
    }
    .wa-send-btn {
        width: 48px;
        height: 48px;
        border-radius: 999px;
        background: #128c7e;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 20px rgba(18, 140, 126, 0.35);
        border: none;
    }
    .wa-emoji-picker {
        margin-top: 10px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 8px;
        display: none;
        flex-wrap: wrap;
        gap: 6px;
        max-width: 520px;
    }
    .wa-emoji-picker.is-open { display: flex; }
    .wa-emoji-picker button {
        font-size: 20px;
        padding: 6px;
        border-radius: 10px;
    }
    .wa-hints {
        display: flex;
        gap: 12px;
        font-size: 11px;
        color: #64748b;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 6px;
    }
    .wa-sticker-picker {
        margin-top: 10px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 18px;
        padding: 10px;
        display: none;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 8px;
        max-width: 520px;
    }
    .wa-sticker-picker.is-open { display: grid; }
    .wa-sticker-picker button {
        font-size: 26px;
        padding: 8px;
        border-radius: 14px;
        background: #f8fafc;
    }
    .wa-sidebar {
        background: #fff;
        border-left: 1px solid #d9e0e4;
        padding: 16px;
        overflow-y: auto;
    }
    .wa-sidebar-header {
        font-weight: 700;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }
    .wa-user {
        width: 100%;
        text-align: left;
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 10px;
        border-radius: 16px;
        transition: background 0.2s ease;
        border: none;
        background: transparent;
        cursor: pointer;
    }
    .wa-user:hover { background: #f1f5f9; }
    .wa-user-name { font-weight: 600; color: #0f172a; }
    .wa-user-status {
        font-size: 11px;
        color: #16a34a;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .wa-user-actions {
        font-size: 11px;
        color: #64748b;
        opacity: 0;
        transition: opacity 0.2s ease;
        margin-top: 4px;
    }
    .wa-user:hover .wa-user-actions { opacity: 1; }

    @media (max-width: 1024px) {
        .wa-grid { grid-template-columns: 1fr; }
        .wa-sidebar { display: none; }
    }
</style>

<div class="max-w-6xl mx-auto px-3 sm:px-4">
    {% set online_count = online_users|length if online_users else 0 %}
    <div class="wa-shell">
        <div class="wa-grid">
            <section class="wa-chat">
                <header class="wa-chat-header">
                    <div class="wa-chat-title">
                        <div class="wa-chat-title-icon"><i class="fas fa-comments"></i></div>
                        <div>
                            <div class="text-sm font-semibold">Forum communautaire</div>
                            <div class="wa-chat-sub">{{ online_count }} en ligne</div>
                        </div>
                    </div>
                </header>

                <div id="chat-window" class="wa-chat-window">
                    {% for msg in messages|reverse %}
                    {% set avatar = None %}
                    {% set sender_name = 'Utilisateur' %}
                    {% set is_me = False %}
                    {% if msg.deliverer and msg.deliverer.profile_picture %}{% set avatar = msg.deliverer.profile_picture if msg.deliverer.profile_picture.startswith('http') else media_url('uploads/profiles/' + msg.deliverer.profile_picture) %}{% endif %}
                    {% if msg.requester and msg.requester.profile_picture %}{% set avatar = msg.requester.profile_picture if msg.requester.profile_picture.startswith('http') else media_url('uploads/profiles/' + msg.requester.profile_picture) %}{% endif %}
                    {% if msg.deliverer %}{% set sender_name = msg.deliverer.first_name ~ ' ' ~ msg.deliverer.last_name %}{% endif %}
                    {% if msg.requester %}{% set sender_name = msg.requester.first_name ~ ' ' ~ msg.requester.last_name %}{% endif %}
                    {% if current_user.is_authenticated %}
                        {% if msg.deliverer and current_user.is_deliverer and msg.deliverer.id == current_user.id %}
                            {% set is_me = True %}
                        {% elif msg.requester and not current_user.is_deliverer and msg.requester.id == current_user.id %}
                            {% set is_me = True %}
                        {% endif %}
                    {% endif %}
                    <div class="wa-message-row {{ 'is-me' if is_me else '' }}">
                        <div class="wa-avatar">
                            {% if avatar %}
                            <img src="{{ avatar }}" alt="avatar" class="h-full w-full object-cover">
                            {% else %}
                            <i class="fas fa-user"></i>
                            {% endif %}
                        </div>
                        <div class="wa-message">
                            <div class="wa-message-meta">
                                <span class="font-semibold">{{ sender_name }}</span>
                                <span class="wa-role">{{ msg.role }}</span>
                            </div>
                            <div class="wa-bubble {{ 'me' if is_me else 'them' }}">
                                {% if msg.content %}
                                <p class="wa-text">{{ msg.content }}</p>
                                {% endif %}
                                {% if msg.attachment_path %}
                                <div class="wa-attachment">
                                    {% set attach_url = msg.attachment_path if msg.attachment_path.startswith('http') else media_url(msg.attachment_path) %}
                                    {% if msg.attachment_type == 'image' %}
                                    <img src="{{ attach_url }}" alt="Piece jointe">
                                    {% elif msg.attachment_type == 'audio' %}
                                    <audio controls class="w-full">
                                        <source src="{{ attach_url }}">
                                    </audio>
                                    {% elif msg.attachment_type == 'video' %}
                                    <video controls>
                                        <source src="{{ attach_url }}">
                                    </video>
                                    {% else %}
                                    <a href="{{ attach_url }}" target="_blank" class="text-sm text-blue-600 hover:underline flex items-center gap-2">
                                        <i class="fas fa-file"></i>Ouvrir le fichier
                                    </a>
                                    {% endif %}
                                </div>
                                {% endif %}
                                <span class="wa-time">{{ msg.created_at.strftime('%d/%m/%Y %H:%M') if msg.created_at else '' }}</span>
                            </div>
                            {% if is_me %}
                            <div class="wa-actions">
                                <button type="button" class="copy-btn" data-copy="{{ (msg.content or '')|replace('\n',' ') }}">
                                    <i class="fas fa-copy"></i> Copier
                                </button>
                                <button type="button" class="edit-toggle" data-edit="edit-form-{{ msg.id }}">
                                    <i class="fas fa-pen"></i> Modifier
                                </button>
                                <form action="{{ url_for('forum') }}" method="POST" onsubmit="return confirm('Supprimer ce message ?');" class="inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="message_id" value="{{ msg.id }}">
                                    <button type="submit" class="flex items-center gap-1">
                                        <i class="fas fa-trash"></i> Supprimer
                                    </button>
                                </form>
                            </div>
                            <div id="edit-form-{{ msg.id }}" class="wa-edit hidden">
                                <form action="{{ url_for('forum') }}" method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="action" value="edit">
                                    <input type="hidden" name="message_id" value="{{ msg.id }}">
                                    <textarea name="content" rows="2">{{ msg.content }}</textarea>
                                    <div class="wa-edit-actions">
                                        <button type="button" class="edit-toggle px-3 py-1 border rounded" data-edit="edit-form-{{ msg.id }}">Annuler</button>
                                        <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded">Enregistrer</button>
                                    </div>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-500">Aucun message pour l‚Äôinstant. Lancez la discussion !</p>
                    {% endfor %}
                </div>

                <form action="{{ url_for('forum') }}" method="POST" enctype="multipart/form-data" class="wa-composer" id="chat-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="wa-input-row">
                        <label class="wa-icon-btn" title="Joindre un media (image/gif/audio/video)">
                            <i class="fas fa-plus"></i>
                            <input type="file" name="attachment" id="attachment-input" accept="image/*,audio/*,video/*" class="hidden">
                        </label>
                        <button type="button" class="wa-icon-btn" id="sticker-btn" title="Stickers / GIF">
                            <i class="fas fa-icons"></i>
                        </button>
                        <button type="button" class="wa-icon-btn" id="emoji-btn" title="Emoji">
                            <i class="fas fa-face-smile"></i>
                        </button>
                        <label class="wa-icon-btn" id="record-btn" title="Enregistrer un vocal">
                            <i class="fas fa-microphone"></i>
                        </label>
                        <textarea name="content" rows="1" class="wa-textarea" placeholder="Message..."></textarea>
                        <button type="submit" class="wa-send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="emoji-picker" class="wa-emoji-picker hidden" hidden aria-hidden="true">
                        {% set emojis = ['üòÄ','üòÅ','üòÇ','ü§£','üòä','üòç','üòò','üòé','üòá','ü§©','ü§î','üò¢','üò°','üëç','üôè','üëè','üî•','‚ú®','üéâ','üéØ','‚ù§Ô∏è','ü§ù','üöÄ'] %}
                        {% for e in emojis %}
                        <button type="button" data-emoji="{{ e }}">{{ e }}</button>
                        {% endfor %}
                    </div>
                    <div id="sticker-picker" class="wa-sticker-picker hidden" hidden aria-hidden="true">
                        {% set stickers = ['üéâ','üòÇ','üòç','üòé','üòá','ü•≥','üî•','üíØ','üëè','üôè','üöÄ','üéØ','‚ú®','ü§ù','üëç'] %}
                        {% for s in stickers %}
                        <button type="button" data-sticker="{{ s }}">{{ s }}</button>
                        {% endfor %}
                    </div>
                    <div class="wa-hints">
                        <span class="flex items-center gap-1"><i class="fas fa-music"></i>Vocal ‚â§5 min</span>
                        <span class="flex items-center gap-1"><i class="fas fa-photo-film"></i>Images / GIF / Videos</span>
                        <span id="record-status" class="text-emerald-600 hidden flex items-center gap-1"><i class="fas fa-circle-notch fa-spin"></i>Enregistrement...</span>
                    </div>
                </form>
            </section>

            <aside class="wa-sidebar">
                <div class="wa-sidebar-header">
                    <i class="fas fa-signal text-green-600"></i>
                    <span>Utilisateurs en ligne</span>
                </div>
                <div class="space-y-2">
                    {% for u in online_users %}
                    <button type="button" class="wa-user" data-call-name="{{ u.name }}" data-call-id="{{ u.user_id }}" {% if u.is_me %}data-self="1"{% endif %}>
                        <div class="wa-avatar">
                            {% if u.avatar %}
                            <img src="{{ u.avatar }}" alt="{{ u.name }}" class="h-full w-full object-cover">
                            {% else %}
                            <i class="fas fa-user"></i>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <div class="wa-user-name">
                                {{ u.name }}{% if u.is_me %} (vous-meme){% endif %}
                            </div>
                            <div class="text-xs text-gray-500 capitalize">{{ u.role }}</div>
                            <div class="wa-user-status"><i class="fas fa-circle text-[8px]"></i>{{ u.status }}</div>
                            <div class="wa-user-actions {% if u.is_me %}hidden{% endif %}">
                                <span class="flex items-center gap-1"><i class="fas fa-phone text-green-600"></i>Appel</span>
                                <span class="flex items-center gap-1"><i class="fas fa-video text-blue-600"></i>Video</span>
                            </div>
                        </div>
                    </button>
                    {% else %}
                    <p class="text-sm text-gray-500">Aucun utilisateur visible pour l'instant.</p>
                    {% endfor %}
                </div>
            </aside>
        </div>
    </div>
</div>

<!-- Call overlay -->
<div id="call-overlay" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-4 space-y-3">
        <div class="flex items-center gap-3">
            <div class="h-12 w-12 rounded-full bg-green-100 text-green-700 flex items-center justify-center">
                <i class="fas fa-phone-volume"></i>
            </div>
            <div>
                <p class="text-sm text-gray-500" id="call-status">Appel...</p>
                <p class="text-lg font-semibold text-gray-800" id="call-peer-name"></p>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <video id="remote-video" class="w-full rounded-xl bg-gray-100 min-h-[160px]" autoplay playsinline></video>
            <video id="local-video" class="w-full rounded-xl bg-gray-100 min-h-[160px]" autoplay muted playsinline></video>
        </div>
        <div class="flex flex-wrap gap-2 justify-end">
            <button id="call-accept" class="hidden px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"><i class="fas fa-check"></i>Accepter</button>
            <button id="call-reject" class="hidden px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 flex items-center gap-2"><i class="fas fa-times"></i>Refuser</button>
            <button id="call-mute" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"><i class="fas fa-microphone-slash"></i>Mute</button>
            <button id="call-camera" class="hidden px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2"><i class="fas fa-video-slash"></i>Cam</button>
            <button id="call-hang" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2"><i class="fas fa-phone-slash"></i>Raccrocher</button>
        </div>
    </div>
</div>

<script>
(() => {
    // Scroll to latest messages
    const chatWindow = document.getElementById('chat-window');
    if (chatWindow) {
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    const recordBtn = document.getElementById('record-btn');
    const statusEl = document.getElementById('record-status');
    const attachInput = document.getElementById('attachment-input');
    const stickerBtn = document.getElementById('sticker-btn');
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPicker = document.getElementById('emoji-picker');
    const stickerPicker = document.getElementById('sticker-picker');
    let mediaRecorder = null;
    let chunks = [];
    let recordTimeout = null;

    function setRecording(isRecording){
        if (!statusEl || !recordBtn) return;
        statusEl.classList.toggle('hidden', !isRecording);
        recordBtn.classList.toggle('is-recording', isRecording);
    }

    async function startRecording(){
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) chunks.push(e.data);
            };
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const file = new File([blob], 'voice-message.webm', { type: 'audio/webm' });
                const dt = new DataTransfer();
                dt.items.add(file);
                if (attachInput) attachInput.files = dt.files;
                stream.getTracks().forEach(t => t.stop());
                setRecording(false);
            };
            mediaRecorder.start();
            setRecording(true);
            recordTimeout = setTimeout(() => stopRecording(), 300000); // 5 minutes max
        } catch (err) {
            console.error(err);
            alert('Impossible d\'acc√©der au micro. V√©rifiez les permissions.');
            setRecording(false);
        }
    }

    function stopRecording(){
        if (recordTimeout) clearTimeout(recordTimeout);
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
    }

    if (recordBtn) {
        recordBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            } else {
                startRecording();
            }
        });
    }

    function setPickerVisible(el, show){
        if (!el) return;
        el.classList.toggle('hidden', !show);
        el.classList.toggle('is-open', show);
        el.hidden = !show;
        el.setAttribute('aria-hidden', show ? 'false' : 'true');
    }

    function closePickers(except){
        if (emojiPicker && emojiPicker !== except) setPickerVisible(emojiPicker, false);
        if (stickerPicker && stickerPicker !== except) setPickerVisible(stickerPicker, false);
    }

    if (stickerBtn && stickerPicker) {
        stickerBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const isHidden = stickerPicker.classList.contains('hidden');
            closePickers(isHidden ? stickerPicker : null);
            setPickerVisible(stickerPicker, isHidden);
        });
        stickerPicker.querySelectorAll('[data-sticker]').forEach(btn => {
            btn.addEventListener('click', () => {
                const textarea = document.querySelector('#chat-form textarea[name="content"]');
                if (!textarea) return;
                const sticker = btn.getAttribute('data-sticker');
                const start = textarea.selectionStart || textarea.value.length;
                const end = textarea.selectionEnd || textarea.value.length;
                textarea.value = textarea.value.slice(0, start) + sticker + textarea.value.slice(end);
                textarea.focus();
                setPickerVisible(stickerPicker, false);
            });
        });
    }

    // Emoji picker
    if (emojiBtn && emojiPicker) {
        emojiBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const isHidden = emojiPicker.classList.contains('hidden');
            closePickers(isHidden ? emojiPicker : null);
            setPickerVisible(emojiPicker, isHidden);
        });
        emojiPicker.querySelectorAll('[data-emoji]').forEach(btn => {
            btn.addEventListener('click', () => {
                const textarea = document.querySelector('#chat-form textarea[name="content"]');
                if (!textarea) return;
                const emoji = btn.getAttribute('data-emoji');
                const start = textarea.selectionStart || textarea.value.length;
                const end = textarea.selectionEnd || textarea.value.length;
                textarea.value = textarea.value.slice(0, start) + emoji + textarea.value.slice(end);
                textarea.focus();
                setPickerVisible(emojiPicker, false);
            });
        });
    }

    document.addEventListener('click', (event) => {
        const target = event.target;
        const clickedEmoji = emojiPicker && emojiPicker.contains(target);
        const clickedSticker = stickerPicker && stickerPicker.contains(target);
        const clickedEmojiBtn = emojiBtn && emojiBtn.contains(target);
        const clickedStickerBtn = stickerBtn && stickerBtn.contains(target);
        if (!clickedEmoji && !clickedSticker && !clickedEmojiBtn && !clickedStickerBtn) {
            closePickers(null);
        }
    });

    closePickers(null);

    // Copier message
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const text = btn.getAttribute('data-copy') || '';
            navigator.clipboard.writeText(text).then(() => {
                alert('Message copie dans le presse-papiers.');
            }).catch(() => {
                alert('Impossible de copier ce message.');
            });
        });
    });

    // Toggle edit forms
    document.querySelectorAll('.edit-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-edit');
            const el = document.getElementById(id);
            if (el) el.classList.toggle('hidden');
        });
    });

    // --- SocketIO + WebRTC (squelette) ---
    const socket = (window.io && typeof window.io === 'function') ? window.io({ transports: ['websocket'] }) : null;
    const peers = {};
    const localMedia = { stream: null };
    // Charger les serveurs ICE depuis le backend (JSON), avec fallback STUN public
    const stunServers = JSON.parse('{{ ice_servers|tojson|safe if ice_servers else "[]" }}');
    if (!Array.isArray(stunServers) || stunServers.length === 0) {
        stunServers.push({ urls: "stun:stun.l.google.com:19302" });
    }
    const currentUserId = "{{ current_user_id }}";
    const currentUserName = "{{ current_user_name }}";
    const overlay = document.getElementById('call-overlay');
    const remoteVideo = document.getElementById('remote-video');
    const localVideo = document.getElementById('local-video');
    const btnAccept = document.getElementById('call-accept');
    const btnReject = document.getElementById('call-reject');
    const btnHang = document.getElementById('call-hang');
    const btnMute = document.getElementById('call-mute');
    const btnCam = document.getElementById('call-camera');
    const callStatusEl = document.getElementById('call-status');
    const peerNameEl = document.getElementById('call-peer-name');
    let currentTarget = null;
    let withVideo = false;

    async function getLocalStream(video=false){
        if (localMedia.stream) return localMedia.stream;
        localMedia.stream = await navigator.mediaDevices.getUserMedia({ audio: true, video });
        return localMedia.stream;
    }

    function createPeer(targetId, withVideo=false){
        const pc = new RTCPeerConnection({ iceServers: stunServers });
        peers[targetId] = pc;
        pc.onicecandidate = (ev) => {
            if (ev.candidate) {
                socket.emit('call:candidate', { to: targetId, candidate: ev.candidate, from: currentUserId });
            }
        };
        pc.ontrack = (ev) => {
            if (remoteVideo) {
                const [stream] = ev.streams;
                remoteVideo.srcObject = stream;
            }
        };
        getLocalStream(withVideo).then(stream => {
            stream.getTracks().forEach(t => pc.addTrack(t, stream));
            if (localVideo) localVideo.srcObject = stream;
        }).catch(err => console.error(err));
        return pc;
    }

    function showOverlay(mode, name){
        if (!overlay) return;
        overlay.classList.remove('hidden');
        peerNameEl.textContent = name || '';
        if (callStatusEl) callStatusEl.textContent = mode;
        [btnAccept, btnReject, btnHang, btnMute, btnCam].forEach(btn => btn && btn.classList.add('hidden'));
        if (mode === 'Entrant') {
            btnAccept.classList.remove('hidden');
            btnReject.classList.remove('hidden');
        } else if (mode === 'En cours') {
            btnHang.classList.remove('hidden');
            btnMute.classList.remove('hidden');
            btnCam.classList.remove('hidden');
        } else if (mode === 'Sortant') {
            btnHang.classList.remove('hidden');
        }
    }

    function hideOverlay(){
        if (overlay) overlay.classList.add('hidden');
        [remoteVideo, localVideo].forEach(v => { if (v) v.srcObject = null; });
    }

    function cleanupPeer(targetId){
        const pc = peers[targetId];
        if (pc) {
            pc.getSenders().forEach(s => s.track && s.track.stop && s.track.stop());
            pc.close();
            delete peers[targetId];
        }
        currentTarget = null;
        withVideo = false;
        hideOverlay();
    }

    async function callUser(targetId, video=false){
        if (!socket || !currentUserId || targetId === currentUserId) return;
        currentTarget = targetId;
        withVideo = video;
        const pc = createPeer(targetId, video);
        showOverlay('Sortant', targetId);
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit('call:init', { to: targetId, from_name: currentUserName, with_video: video });
        socket.emit('call:offer', { to: targetId, offer, from: currentUserId, with_video: video });
    }

    if (socket) {
        socket.on('connect', () => console.log('SocketIO connecte'));
        socket.on('presence:update', (data) => {
            console.log('Presence', data);
        });
        socket.on('call:ring', (payload) => {
            currentTarget = payload.from;
            withVideo = payload.with_video;
            showOverlay('Entrant', payload.from_name || 'Utilisateur');
        });
        socket.on('call:busy', () => {
            alert("L'utilisateur est occupe.");
            hideOverlay();
        });
        socket.on('call:ready', () => {
            // callee accepted, caller will proceed (already sent offer)
            showOverlay('En cours', currentTarget);
        });
        socket.on('call:rejected', () => {
            alert('Appel rejete.');
            hideOverlay();
        });
        socket.on('call:offer', async (data) => {
            const from = data.from || data.to;
            currentTarget = from;
            withVideo = data.with_video;
            const pc = createPeer(from, data.with_video);
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('call:answer', { to: from, answer, from: currentUserId });
            showOverlay('En cours', data.from_name || 'En appel');
        });
        socket.on('call:answer', async (data) => {
            const pc = peers[data.from || data.to];
            if (pc) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
            showOverlay('En cours', currentTarget);
        });
        socket.on('call:candidate', (data) => {
            const pc = peers[data.from || data.to];
            if (pc && data.candidate) {
                pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        });
        socket.on('call:end', (data) => {
            const tid = data.from || data.to || currentTarget;
            cleanupPeer(tid);
        });
    }

    const onlineButtons = document.querySelectorAll('[data-call-name]');
    onlineButtons.forEach(btn => {
        if (btn.getAttribute('data-self')) return;
        btn.addEventListener('click', () => {
            const name = btn.getAttribute('data-call-name');
            const target = btn.getAttribute('data-call-id');
            const choice = confirm(`Appeler ${name} ?\nOK: appel vocal\nAnnuler: appel video`);
            callUser(target, !choice);
        });
    });

    if (btnAccept) btnAccept.addEventListener('click', () => {
        if (!socket || !currentTarget) return;
        socket.emit('call:accept', { to: currentTarget });
        showOverlay('En cours', currentTarget);
    });
    if (btnReject) btnReject.addEventListener('click', () => {
        if (!socket || !currentTarget) return;
        socket.emit('call:reject', { to: currentTarget });
        cleanupPeer(currentTarget);
    });
    if (btnHang) btnHang.addEventListener('click', () => {
        if (socket && currentTarget) socket.emit('call:end', { to: currentTarget });
        cleanupPeer(currentTarget);
    });
    if (btnMute) btnMute.addEventListener('click', () => {
        if (localMedia.stream) {
            const enabled = localMedia.stream.getAudioTracks().some(t => t.enabled);
            localMedia.stream.getAudioTracks().forEach(t => t.enabled = !enabled);
            btnMute.querySelector('i').className = enabled ? 'fas fa-microphone-slash' : 'fas fa-microphone';
        }
    });
    if (btnCam) btnCam.addEventListener('click', () => {
        if (localMedia.stream) {
            const enabled = localMedia.stream.getVideoTracks().some(t => t.enabled);
            localMedia.stream.getVideoTracks().forEach(t => t.enabled = !enabled);
            btnCam.querySelector('i').className = enabled ? 'fas fa-video-slash' : 'fas fa-video';
        }
    });
})();
</script>
